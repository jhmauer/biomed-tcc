##########Juntar (merge) arquivos de diferentes pacientes/diferentes genotipagens (ultima atualizacao em 09_06_19)
#PLINK v2.00a2LM 64-bit Intel (27 May 2019) 
#bcftools Version: 1.4.1-1-gcdac3db (using htslib 1.4.1-1-g7771288)
#VCFtools (0.1.15)
# por Jessica Mauer

# Partindo dos arquivos saídos do controle de qualidade pós-imputação, remover SNPs duplicados no dataset (rs ids duplicados são provavelmente variantes trialélicas)
plink2 --pfile ptsd_imputado_QC_new --rm-dup exclude-mismatch --make-pgen --out ptsd_imputado_QC_semdup
plink2 --pfile ptsd_imputado_QC_semdup --export vcf --out ptsd_plink2
bgzip -c ptsd_plink2.vcf > ptsd_plink2.vcf.gz 
bcftools index ptsd_plink2.vcf.gz
bcftools merge -Ov scz_plink2.vcf.gz pep_plink2.vcf.gz ptsd_plink2.vcf.gz -o pep_scz_tept_merge.vcf

############ Controle de qualidade pós-merge
#1) Filtros
plink2 --vcf pep_scz_tept_merge.vcf --max-alleles-2 --maf 0.01 --geno 0.05 --hwe 0.001 --make-pgen --out pep_scz_tept_merge_filtros

#2) Sem indels
plink2 --pfile pep_scz_tept_merge_filtros --snps-only just-acgt --make-bed --out pep_scz_tept_merge_semindels

#2) Atualizar sexo e fenótipo
#Fazendo arquivo updatesex:
awk '{print $1, $2, $5}' SCZ_QC_ibd.fam > upd_sex_scz.txt

#Fazendo arquivo fenotipo
awk '{print $1, $2, $6}' SCZ_QC_ibd.fam > upd_pheno_scz.txt

#Atualizando fenotipo e sexo
plink --bfile scz_imp_semindels --update-sex upd_sex_scz.txt --pheno upd_pheno_scz.txt --make-bed --out scz_imputado_sex_pheno

#2) Individual missingness x heterozigozity
plink2 --pfile pep_scz_tept_merge_filtros --missing --het --out merge
#R:
imiss <- read.table('merge.imiss',h=T)
het <- read.table('merge.het',h=T)
het$P_HET <- (het$N.NM. - het$O.HOM.) / het$N.NM.
upper_3sd <- mean(het$P_HET) + 3*sd(het$P_HET)
lower_3sd <- mean(het$P_HET) - 3*sd(het$P_HET)
imiss_rem <- subset(imiss,imiss$F_MISS > 0.03)[,1:2]
het_rem <- subset(het,het$P_HET > upper_3sd | het$P_HET < lower_3sd)[,1:2]
indiv_rem <- rbind(imiss_rem,het_rem)
write.table(indiv_rem,'fail-imisshet-qc.txt',col=F,row=F,quo=F,sep='\t')

#linha de comando: 
plink2 --pfile pep_scz_tept_merge_filtros --remove fail-imisshet-qc.txt --make-pgen --out pep_scz_tept_merge_filtros_semhet

#3) Exclusão de individuos c/ compartilhamento genético: IBD
plink2 --pfile pep_scz_tept_merge_filtros_semhet --indep-pairwise 50 5 0.2 --out merge_pruning
plink2 --pfile pep_scz_tept_merge_filtros_semhet --extract merge_pruning.prune.in --genome --min 0.3 --out ibd_calculation
awk '{ print $3,$4 }' ibd_calculation.genome > individuosrelacionados.txt 
plink2 --pfile pep_scz_tept_merge_filtros_semhet --remove individuosrelacionados.txt --make-pgen --out pep_scz_tept_merge_QCfinal

#4) PCA
plink2 --pfile pep_scz_tept_merge_QCfinal --pca 4 --out pepscztept_pca 
