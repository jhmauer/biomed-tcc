########## Análise de associação (ultima atualizacao em 09_06_19)
#PLINK v2.00a2LM 64-bit Intel (27 May 2019) 
#R version 3.4.4 (2018-03-15) -- "Someone to Lean On"
#por Jessica Mauer

#associacao bruta (sem correção p/ pca)
plink2 --pfile final2 --glm --out assoc_bruta_pepscztept

#Associação corrigindo para múltiplas comparações e também para os 4 primeiros PCs

plink2 --bfile pep_scz_tept_merge_QCfinal --adjust --covar pepscztept_pca --covar-col-nums 3-6 --glm --out assoc_pep_scz_tept

#Selecionar do arquivo gerado o cabeçalho + linhas que tenham os resultados dos SNPs (coluna TEST = ADD)

egrep '#|ADD' assoc_pep_scz_tept.PHENO1.glm.logistic > assoc_SNPs.PHENO1.glm.logistic
egrep '#|ADD' assoc_bruta_pepscztept.PHENO1.glm.logistic > assoc_bruta_SNPs.PHENO1.glm.logistic

#####GRÁFICOS - R#####
#importar o arquivo
corrigido <- read.table("assoc_SNPs.PHENO1.glm.logistic", header = T, comment.char = "@")
bruto <-  read.table("assoc_bruta_SNPs.PHENO1.glm.logistic", header = T, comment.char = "@")

#renomear colunas
names(corrigido)[1] <- "CHR"
names(corrigido)[2] <- "BP"
names(bruto)[1] <- "CHR"
names(bruto)[2] <- "BP"

library(qqman) 

#QQ  Plot

png("qq_bruto_P.png")
qq(bruto$P)
dev.off()

png("qq_corrigido_P.png")
qq(corrigido$P)
dev.off()

#Manhattan plot
png("manhattan_corrigido_P.png")
manhattan(corrigido, main = “titulo”, col = c(“indianred”, “indianred4”), cex.axis = 0.8)
dev.off()

######Selecionar os n primeiros SNPs pelo valor de P - R ##########
library(dplyr)
resultadoordenado <- arrange(corrigido, P)

#Selecionar, por exemplo, os 100 primeiros snps e salvar em uma tabela
100topsnps <- slice(resultadoordenado, 1:100)
write.csv2(100topsnps, "100topsnps.csv", row.names=F)

